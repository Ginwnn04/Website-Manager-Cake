<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Bán Bánh</title>
    <style>
        body {
    font-family: 'Arial', sans-serif;
    background-color: #fafafa;
    margin: 0;
    padding: 0;
    color: #333;
}

.container {
    width: 80%;
    margin: auto;
}

h3 {
    text-align: center;
    color: #4CAF50;
}

button {
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}

button:hover {
    background-color: #45a049;
}

/* Nút đăng ký, đăng nhập, giỏ hàng, đăng xuất */
.auth-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.auth-buttons button {
    background-color: #4CAF50;
    color: white;
    border: none;
}

#logoutBtn {
    display: none;
    background-color: #ff6347;
}

/* Modal - Đăng ký, Đăng nhập, Giỏ hàng */
.modal {
    display: none;
    background-color: rgba(0, 0, 0, 0.5);
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: white;
    padding: 20px;
    border-radius: 8px;
    width: 300px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.modal h3 {
    color: #333;
    text-align: center;
    margin-bottom: 20px;
}

.modal input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 5px;
    border: 1px solid #ddd;
}

.modal button {
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    background-color: #4CAF50;
    color: white;
    border: none;
}

.modal button:hover {
    background-color: #45a049;
}

/* Sản phẩm */
.product {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: white;
    padding: 10px;
    margin: 15px 0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.product img {
    width: 100px;
    height: 100px;
    border-radius: 8px;
}

.product-details {
    flex-grow: 1;
    margin-left: 20px;
}

.product h4 {
    margin: 0;
    color: #4CAF50;
}

.product p {
    margin: 5px 0;
}

.product button {
    margin-top: 10px;
}

/* ----------------------------Giỏ hàng-------------------------------- */
#cart {
    display: none;
    position: fixed;
    top: 0;
    right: 0;
    width: 300px;
    height: 100%;
    background-color: white;
    box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    overflow-y: auto;
}

#cart h3 {
    margin-top: 0;
    text-align: center;
}

#cart ul {
    list-style-type: none;
    padding: 0;
}

#cart ul li {
    padding: 10px 0;
    border-bottom: 1px solid #ddd;
}

/* Responsive */
@media (max-width: 768px) {
    .product {
        flex-direction: column;
        align-items: flex-start;
    }

    .product img {
        margin-bottom: 10px;
    }

    .auth-buttons {
        flex-direction: column;
    }

    #cart {
        width: 100%;
    }
}
/* -------------------------Avatar và menu thông tin người dùng -------------------*/
.user-avatar {
    position: relative;
    display: inline-block;
    cursor: pointer;
    height: auto;
    width: 300px;
}

.avatar-img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
}

.profile-menu {
    display: none;
    position: absolute;
    top: 50px;
    right: 0;
    background-color: white;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.profile-menu p {
    margin: 5px 0;
}

.profile-menu button {
    background-color: #ff4d4d;
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 5px;
}


#confirmationModal .modal-content {
    width: 300px;
}

#cartItems img {
    margin-right: 10px;
    vertical-align: middle;
}

#confirmProductList {
    display: flex;
    flex-wrap: wrap;  /* Cho phép các ảnh xuống hàng khi không còn đủ không gian */
    justify-content: center;  /* Căn giữa các ảnh trong hàng */
    gap: 10px;  /* Khoảng cách giữa các ảnh */
}

.product-image {
    display: flex;
    justify-content: center;  /* Căn giữa ảnh trong phần tử */
}

.product-img {
    max-width: 100px;  /* Giới hạn kích thước ảnh */
    max-height: 100px;  /* Giới hạn chiều cao ảnh */
}

    </style>
</head>
<body>
    <div class="container">
        <!-- Nút đăng ký, đăng nhập, giỏ hàng và đăng xuất -->
        <div class="auth-buttons">
            <button onclick="toggleRegister()">Đăng ký</button>
            <button onclick="toggleLogin()">Đăng nhập</button>
            <button onclick="toggleCart()">Giỏ hàng</button>
            <button id="logoutBtn" onclick="logout()" style="display:none;">Đăng xuất</button>

            <!-- Avatar người dùng sau khi đăng nhập -->
            <div id="userAvatar" class="user-avatar" style="display:none;" onclick="toggleProfileMenu()">
                <img src="avatar.png" alt="Avatar" class="avatar-img">
                <div id="profileMenu" class="profile-menu" style="display:none;">
                    <p id="userFullName">Tên người dùng</p>
                    <p id="userPhone">Số điện thoại</p>
                    <p id="userAddress">Địa chỉ</p>
                </div>
            </div>
        </div>

        <!-- Modal Đăng ký -->
        <div id="registerForm" class="modal">
            <div class="modal-content">
                <h3>Đăng ký tài khoản</h3>
                <input type="text" id="registerPhone" placeholder="Số điện thoại"><br>
                <input type="password" id="registerPassword" placeholder="Mật khẩu"><br>
                <input type="password" id="confirmPassword" placeholder="Xác nhận mật khẩu"><br>
                <input type="text" id="fullName" placeholder="Họ và tên"><br>
                <input type="text" id="address" placeholder="Địa chỉ"><br>
                <button onclick="register()">Đăng ký</button>
                <button onclick="closeModal('registerForm')">Đóng</button>
            </div>
        </div>

        <!-- Modal Đăng nhập -->
        <div id="loginForm" class="modal">
            <div class="modal-content">
                <h3>Đăng nhập</h3>
                <input type="text" id="loginPhone" placeholder="Số điện thoại"><br>
                <input type="password" id="loginPassword" placeholder="Mật khẩu"><br>
                <button onclick="login()">Đăng nhập</button>
                <button onclick="closeModal('loginForm')">Đóng</button>
            </div>
        </div>

        <!-- Modal Giỏ hàng -->
        <div id="cart" class="modal">
            <div class="modal-content">
                <h3>Giỏ hàng</h3>
                <ul id="cartItems">
                    <!-- Sản phẩm của giỏ hàng -->
                </ul>
                <p id="totalPrice">Tổng tiền: 0 VND</p>
                <button onclick="confirmPurchase()">Mua ngay</button>
                <button onclick="closeModal('cart')">Đóng</button>
            </div>
        </div>

        <!-- Modal Xác nhận mua hàng -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <h3>Xác nhận mua hàng</h3>
                <label>Họ tên:</label>
                <input type="text" id="confirmName" disabled><br>
                <label>Số điện thoại:</label>
                <input type="text" id="confirmPhone" disabled><br>
                <label>Địa chỉ:</label>
                <input type="text" id="confirmAddress"><br>
                <div id="confirmProductList"></div> <!-- Thêm phần này để hiển thị ảnh sản phẩm -->
                <p id="confirmTotalPrice">Tổng tiền: 0 VND</p>
                <button onclick="finalizePurchase()">Xác nhận</button>
                <button onclick="closeModal('confirmationModal')">Hủy</button>
            </div>
        </div>


        <!-- Sản phẩm -->
        <div id="products">
            <h3>Danh sách sản phẩm</h3>
            <!-- Các sản phẩm sẽ được thêm động từ localStorage -->
        </div>
    </div>

    <script >
        let cart = [];
let singleItemPurchase = null;  // Variable to hold information for single product purchase

// Check if the user is logged in
function checkLogin() {
    const currentUser = localStorage.getItem('currentUser');
    if (!currentUser) {
        alert("Vui lòng đăng nhập để thực hiện hành động này.");
        toggleLogin();  // Show login modal if not logged in
        return false;  // Return false if not logged in
    }
    return true;  // Return true if logged in
}

// Toggle modals for Register, Login, and Cart
function toggleRegister() {
    document.getElementById("registerForm").style.display = 'flex';
    document.getElementById("loginForm").style.display = 'none';
    document.getElementById("cart").style.display = 'none';
}

function toggleLogin() {
    document.getElementById("loginForm").style.display = 'flex';
    document.getElementById("registerForm").style.display = 'none';
    document.getElementById("cart").style.display = 'none';
}

function toggleCart() {
    if (!checkLogin()) return; // Check if the user is logged in
    document.getElementById("cart").style.display = 'flex';
    document.getElementById("registerForm").style.display = 'none';
    document.getElementById("loginForm").style.display = 'none';
    displayCartItems();
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// Register new user
function register() {
    const phone = document.getElementById("registerPhone").value;
    const password = document.getElementById("registerPassword").value;
    const confirmPassword = document.getElementById("confirmPassword").value;
    const fullName = document.getElementById("fullName").value;
    const address = document.getElementById("address").value;

    if (password !== confirmPassword) {
        alert("Mật khẩu không khớp!");
        return;
    }

    const user = { phone, password, fullName, address };
    let users = JSON.parse(localStorage.getItem('users')) || [];
    users.push(user);
    localStorage.setItem('users', JSON.stringify(users));

    alert("Đăng ký thành công!");
    closeModal('registerForm');
}

// Login user
function login() {
    const phone = document.getElementById("loginPhone").value;
    const password = document.getElementById("loginPassword").value;

    const users = JSON.parse(localStorage.getItem('users')) || [];
    const user = users.find(u => u.phone === phone && u.password === password);
    if (user) {
        alert("Đăng nhập thành công!");
        localStorage.setItem('currentUser', JSON.stringify(user));  // Save logged-in user info
        displayUserAvatar(user); // Show user's avatar
        closeModal('loginForm');
    } else {
        alert("Số điện thoại hoặc mật khẩu không đúng!");
    }
}

// Logout user
function logout() {
    localStorage.removeItem('currentUser');  // Remove logged-in user info
    document.getElementById("userAvatar").style.display = 'none';
    document.getElementById("logoutBtn").style.display = 'none';
    alert("Đã đăng xuất thành công!");
    window.location.href = 'test.html';
}

// Add product to cart
function addToCart(name, price, image) {
    if (!checkLogin()) return;  // Check if user is logged in

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    cart.push({ name, price, image });
    saveUserCart(currentUser.phone);  // Save user's cart to localStorage
    alert(`${name} đã được thêm vào giỏ hàng.`);
}

// Save user's cart to localStorage
function saveUserCart(phone) {
    localStorage.setItem(`cart_${phone}`, JSON.stringify(cart));
}

// Display cart items
function displayCartItems() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        alert("Vui lòng đăng nhập.");
        toggleLogin();
        return;
    }
    const cartItemsList = document.getElementById("cartItems");
    const totalPriceElem = document.getElementById("totalPrice");
    cartItemsList.innerHTML = '';
    let totalPrice = 0;

    // Load user's cart from localStorage
    cart = JSON.parse(localStorage.getItem(`cart_${currentUser.phone}`)) || [];

    cart.forEach((item, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
            <input type="checkbox" class="cart-checkbox" checked data-index="${index}" onclick="updateTotalPrice()">
            <img src="${item.image}" alt="${item.name}" style="width:50px; height:50px;">
            <span>${item.name} - ${item.price} VND</span>
        `;
        cartItemsList.appendChild(li);
        totalPrice += item.price;
    });

    totalPriceElem.innerText = `Tổng tiền: ${totalPrice} VND`;
}

// Update total price when user selects or deselects a product
function updateTotalPrice() {
    if (!cart) return; // Check if cart exists
    const checkboxes = document.querySelectorAll(".cart-checkbox");
    let totalPrice = 0;
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const index = checkbox.getAttribute('data-index');
            totalPrice += cart[index].price;
        }
    });
    document.getElementById("totalPrice").innerText = `Tổng tiền: ${totalPrice} VND`;
}

// Display products from localStorage
function displayProducts() {
    const productContainer = document.getElementById("products");
    const products = JSON.parse(localStorage.getItem('products')) || [];

    productContainer.innerHTML = ''; // Clear previous products
    products.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        productDiv.innerHTML = `
            <img src="${product.image}" alt="${product.name}">
            <div class="product-details">
                <h4>${product.name}</h4>
                <p>Giá: ${product.price} VND</p>
                <button onclick="addToCart('${product.name}', ${product.price}, '${product.image}')">Thêm vào giỏ hàng</button>
                <button onclick="confirmSinglePurchase('${product.name}', ${product.price}, '${product.image}')">Mua ngay</button>
            </div>
        `;
        productContainer.appendChild(productDiv);
    });
};

// Display user information and avatar after login
function displayUserAvatar(user) {
    document.getElementById("logoutBtn").style.display = 'inline-block';
    document.getElementById("userAvatar").style.display = 'inline-block';
    document.getElementById("userFullName").innerText = user.fullName;
    document.getElementById("userPhone").innerText = `SĐT: ${user.phone}`;
    document.getElementById("userAddress").innerText = `Địa chỉ: ${user.address}`;
};

// Toggle profile menu visibility
function toggleProfileMenu() {
    const profileMenu = document.getElementById("profileMenu");
    profileMenu.style.display = profileMenu.style.display === 'none' ? 'block' : 'none';
};

// Display confirmation form when purchasing
function confirmPurchase() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const confirmationModal = document.getElementById("confirmationModal");

    // Display user information
    document.getElementById("confirmName").value = currentUser.fullName;
    document.getElementById("confirmPhone").value = currentUser.phone;
    document.getElementById("confirmAddress").value = currentUser.address;
    document.getElementById("confirmTotalPrice").innerText = document.getElementById("totalPrice").innerText;

    // Display selected products in the cart
    const confirmProductList = document.getElementById("confirmProductList");
    confirmProductList.innerHTML = '';  // Clear previous products

    const checkboxes = document.querySelectorAll(".cart-checkbox");
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const index = checkbox.getAttribute('data-index');
            const product = cart[index];
            const productElement = document.createElement('div');
            productElement.className = "product-image";  // Add class for easy CSS styling
            productElement.innerHTML = `
                <img src="${product.image}" alt="${product.name}" class="product-img">
            `;
            confirmProductList.appendChild(productElement);
        }
    });

    confirmationModal.style.display = 'flex';
}

// Confirm purchase of a single product
function confirmSinglePurchase(name, price, image) {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    singleItemPurchase = { name, price, image };  // Save single product purchase info

    const confirmationModal = document.getElementById("confirmationModal");

    // Display user information
    document.getElementById("confirmName").value = currentUser.fullName;
    document.getElementById("confirmPhone").value = currentUser.phone;
    document.getElementById("confirmAddress").value = currentUser.address;

    // Display the single product in confirmation modal
    const confirmProductList = document.getElementById("confirmProductList");
    confirmProductList.innerHTML = '';  // Clear previous products

    const productElement = document.createElement('div');
    productElement.innerHTML = `
        <img src="${singleItemPurchase.image}" alt="${singleItemPurchase.name}" style="display: block; margin: 0 auto; max-width: 200px;">
    `;
    confirmProductList.appendChild(productElement);

    document.getElementById("confirmTotalPrice").innerText = `Tổng tiền: ${singleItemPurchase.price} VND`;

    confirmationModal.style.display = 'flex';
}

// Finalize the purchase
function finalizePurchase() {
    const address = document.getElementById("confirmAddress").value; 
    const currentUser = JSON.parse(localStorage.getItem('currentUser')); 
    const currentDate = new Date();
    
    // Lấy ngày theo định dạng yyyy-mm-dd
    const year = currentDate.getFullYear();
    const month = String(currentDate.getMonth() + 1).padStart(2, '0'); // Đảm bảo tháng luôn có 2 chữ số
    const day = String(currentDate.getDate()).padStart(2, '0'); // Đảm bảo ngày luôn có 2 chữ số
    
    const formattedDate = `${year}-${month}-${day}`; // Định dạng yyyy-mm-dd
    
    let itemsToPurchase = [];
    let totalPrice = 0;

    if (singleItemPurchase) {
        itemsToPurchase.push(singleItemPurchase);
        totalPrice = singleItemPurchase.price;
    } else {
        const checkboxes = document.querySelectorAll(".cart-checkbox");
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const index = checkbox.getAttribute('data-index');
                itemsToPurchase.push(cart[index]);
            }
        });
        
        if (itemsToPurchase.length === 0) {
            alert("Vui lòng chọn ít nhất một sản phẩm để đặt hàng.");
            return;
        }
        totalPrice = itemsToPurchase.reduce((acc, item) => acc + item.price, 0);
    }

    const order = {
        orderId: "id" + new Date().getTime(), 
        user: { 
            fullName: currentUser.fullName, 
            phone: currentUser.phone, 
            address: address 
        },
        date: formattedDate, // Lưu ngày theo định dạng yyyy-mm-dd
        items: itemsToPurchase,  
        totalPrice: totalPrice,  
        status: "Chưa xử lý",  
    };

    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    
    // Thêm đơn hàng mới vào mảng orders
    orders.unshift(order);  // Đẩy đơn hàng mới từ finalizePurchase lên đầu mảng

    // Đảm bảo `newOrder` chứa các phần tử, nếu không hãy debug bằng cách console.log
    const newOrder = [
        { orderId: "id123456781", user: { fullName: "Lê Công Vinh", phone: "0902580641", address: "453/133 Lê Văn Sỹ, phường 12, quận 3, Tp.HCM" }, date: "2024-11-10", items: [{ name: "Bánh kem", price: 150000, image: "undefined" }], totalPrice: 150000, status: "Chưa xử lý" },
        { orderId: "id123456782", user: { fullName: "Nguyễn Thị Lan", phone: "0902580642", address: "123/45 Nguyễn Thị Minh Khai, quận 1, Tp.HCM" }, date: "2024-11-11", items: [{ name: "Bánh mì", price: 20000, image: "undefined" }], totalPrice: 20000, status: "Chưa xử lý" },
    ];

    // Debug log để kiểm tra xem `orders` trước và sau khi thêm dữ liệu có thay đổi không
    console.log("Orders before update:", orders);
    
    // Thêm đơn hàng mới vào mảng orders
    orders.push(...newOrder);  // Dùng spread operator để thêm các phần tử từ newOrder vào orders

    // Debug log sau khi cập nhật mảng orders
    console.log("Orders after update:", orders);

    // Lưu lại toàn bộ mảng orders vào localStorage
    localStorage.setItem('orders', JSON.stringify(orders));

    // Kiểm tra lại xem dữ liệu đã được lưu vào localStorage chưa
    console.log("Orders saved to localStorage:", localStorage.getItem('orders'));

    if (!singleItemPurchase) {
        cart = [];
        saveUserCart(currentUser.phone); 
    }

    singleItemPurchase = null;
    alert("Đặt hàng thành công!");
    closeModal('confirmationModal'); 
}


// Load user data and products when the page is loaded
window.onload = function() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (currentUser) {
        displayUserAvatar(currentUser);
    }
    displayProducts();
};

    </script>
</body>
</html>
